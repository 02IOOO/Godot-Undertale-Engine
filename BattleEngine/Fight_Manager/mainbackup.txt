extends Fightmanager
class_name main
var fullsc


@onready var platform = preload("res://Shared/misc/platform.tscn")
@onready var bg = get_node("/root/main/ParallaxBackground")
@onready var bone = preload("res://BattleEngine/Fight_Manager/Enemies/bone.tscn")
@onready var blaster = preload("res://BattleEngine/Fight_Manager/Enemies/blaster.tscn")
@onready var warning = preload("res://BattleEngine/gui/warning.tscn")
@onready var Camera = get_node("/root/main/Camera2D")
@onready var Blinder = get_node("/root/main/Camera2D/ColorRect")
@onready var Box = get_node("/root/main/box")
@onready var Butn = get_node("/root/main/buttons")
@onready var Fight = get_node("/root/main/box/fight")
@onready var Boss = get_node("/root/main/boss")
@onready var Player = get_node("/root/main/soul")
@onready var attacks = Box.get_node("PutThings")

var currentattack = 0
var heart = preload("res://Shared/Soul/soul.tscn")
@onready var bosspos = Boss.position

func boxadd(target: Node,time = 1):
	var originalparent = target.get_parent()
	var tpos = target.global_position
	originalparent.remove_child(target)
	Box.add_child(target)
	target.global_position = tpos
	await get_tree().create_timer(time).timeout
	Box.remove_child(target)
	originalparent.add_child(target)

func changesoulpos(dir):
	if dir == "down":
		Box.soulpos -= 2
	if dir == "up":
		Box.soulpos += 2

func warn(x,y,modx,mody,time):
	var warn = warning.instantiate()
	Box.add_child(warn)
	warn.summonwarn(x,y,modx,mody,time)


func setmode(col:String):
	Player.setmode(col)

func boxsize(x,y,mx= 0,my= 0,t = Box.sizetime):
	Box.changesize(x,y,mx,my,t)
	
func throw(dir):
	Boss.throwanim(dir)
	await get_tree().create_timer(0.1).timeout
	Player.throw(dir)
	
func direct(dir):
	Player.mode = "blue"
	Player.changedir(dir)
# Called when the node enters the scene tree for the first time.
func _ready():
	Data.changedpage.connect(changesoulpos)
	Player.hide()
	Box.fight.connect(Fight.start)
	Butn.select.connect(changetext)
	Fight.damageplace.connect(hurted)
	Boss.finishspeech.connect(Player.intobattle)
	Box.menu.connect(Butn.enable)
	await Butn.finishintro
	Player.fightpos = Butn.get_child(0).global_position - Vector2(38,0)
	

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	#ESC
	pass
	#Boss.position = bosspos + bg.vel *delta

func changetext(choice):
	await get_tree().create_timer(0.1).timeout
	Box.get_node("NinePatchRect/Label").text = ""
	Box.get_node("NinePatchRect/Label/Label").text = ""
	Box.get_node("NinePatchRect/Label/Label2").text = ""
	match choice:
		0:
			Box.SelectedAction = 0
			Box.menulist(1)
			Box.writeoptions(EnemyName)
			Box.inpos = true
		1:
			Box.SelectedAction = 1
			Box.menulist(3)
			Box.writeoptions("Check","Pray","Insult")
			Box.inpos = true
		2:
			
			Box.SelectedAction = 2
			Box.menulist(4)
			var i = Data.returnItemArray(0).split("\n")
			Box.writeoptions(i[0],i[1],i[2],i[3],"","1/2 (â†“)")
			Box.inpos = true
		3:
			Box.SelectedAction = 3
			Box.menulist(1)
			Box.writeoptions(EnemyName)
			Box.inpos = true
func hurted(damage):
	if damage &&damage >0:
		Boss.anim.play("hurt")
		Boss.sprites.velocity.y -= 60
		await get_tree().create_timer(1.8).timeout
	else:
		await get_tree().create_timer(1.8).timeout
	Boss.limits()



func summonbones(posx= 0,posy = 420,velx = 300,vely= 0,size = 90,Rotation = 0,mode = 0,endx = null):
	var clone = bone.instantiate()
	#Box.putattack(clone)
	Box.get_node("PutThings").add_child(clone)
	clone.fire(velx,vely,size,mode,Rotation,endx)
	clone.global_position = Vector2(posx, posy) + Box.position
	return clone
func summonblaster(posx= 0,posy=0,rot=null,width=null,delay = 1,color = 0):
	var clone = blaster.instantiate()
	add_child(clone)
	if posx != null:
		clone.fire(posx,posy,rot,width,delay,color)
	return clone
func summonplatform(posx =0,posy=0,tx=0,ty=0,color="green"):
	var clone = platform.instantiate()
	Box.add_child(clone)
	clone.cast(posx,posy,tx,ty,color)
	return clone
func heal(heal):
	heal =int(heal)
	Player.healfx.play()
	Player.hp += heal
	if Player.hp> Player.maxhp:
		Player.hp = Player.maxhp
	var t = get_tree().create_tween()
	t.tween_property(Camera,"zoom",Vector2(1.02,1.02),0.25).set_trans(Tween.TRANS_BACK)
	t.tween_property(Camera,"zoom",Vector2(1,1),0.25).set_trans(Tween.TRANS_CUBIC)
